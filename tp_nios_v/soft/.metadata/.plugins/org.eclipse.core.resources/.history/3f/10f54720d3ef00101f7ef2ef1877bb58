#include <stdint.h>
#include <unistd.h>
#include "system.h"
#include "altera_avalon_pio_regs.h"
#include "altera_avalon_i2c.h"

#define ADXL_ADDR 0x53

static ALT_AVALON_I2C_DEV_t *i2c;

static uint8_t read_reg(uint8_t reg)
{
    uint8_t tx[1] = { reg };
    uint8_t rx[1] = { 0 };

    alt_avalon_i2c_master_target_set(i2c, ADXL_ADDR);
    alt_avalon_i2c_master_tx_rx(i2c, tx, 1, rx, 1, ALT_AVALON_I2C_NO_INTERRUPTS);
    return rx[0];
}

int main(void)
{
    i2c = alt_avalon_i2c_open(I2C_0_NAME);
    if(!i2c){
        IOWR_ALTERA_AVALON_PIO_DATA(PIO_0_BASE, 0x003); // LED0+LED1
        while(1);
    }

    uint8_t id = read_reg(0x00);

    if(id == 0xE5)
        IOWR_ALTERA_AVALON_PIO_DATA(PIO_0_BASE, 0x3FF);  // tout ON
    else
        IOWR_ALTERA_AVALON_PIO_DATA(PIO_0_BASE, (uint32_t)id); // affiche id sur LED0..7

    while(1);
}
